# 2月26日（Layer 1 MVP）必須機能 - 追加検討

## 概要

現在の要件リストと既存の要件定義を比較し、2月26日までに必須にすべき機能を検討します。

---

## 現在の優先度1（必須）機能リスト

| No. | 機能分類 | 要件名 | 概要 | 優先度 |
|-----|---------|--------|------|--------|
| 1 | 基本機能 | LINE登録 | 公式アカウントを各ユーザーの友だちに追加する | 1 |
| 2 | 基本機能 | メニュー表示 | メニュー画面を表示して、各メニューを選択できる | 1 |
| 3 | ガチャ機能 | ガチャ選択 | ガチャ一覧を表示する、各ガチャの詳細内容を確認できる | 1 |
| 4 | 基本機能 | 決済 | ガチャをプレイするための決済機能 | 1 |
| 5 | ガチャ機能 | ガチャプレイ | ガチャの演出映像を表示する | 1 |
| 6 | ガチャ機能 | 結果通知 | LINEメッセージでガチャの結果をユーザーに送信する | 1 |
| 7 | ガチャ機能 | アイテム表示 | ユーザーが所有するアイテムの一覧を表示する | 1 |
| 8 | ガチャ機能 | アイテム使用 | アイテム詳細からアイテムを使用する | 1 |
| 9 | 基本機能 | 友だち紹介 | ユーザーが公式アカウントをシェアできる | 1 |
| 10 | 管理機能 | ユーザー管理 | ユーザー一覧とユーザーの詳細情報を確認できる | 1 |
| 11 | 管理機能 | ガチャ設定 | 各ガチャの設定ができる | 1 |
| 12 | 管理機能 | アイテム設定 | アイテムの情報設定 | 1 |
| 13 | 管理機能 | メッセージ配信 | 公式アカウントから配信するメッセージの設定 | 1 |

---

## 追加で言及されている機能

### 管理機能
- **ガチャシミュレータ**: 設定したガチャの排出率、景品が正しく設定されているか確認する画面
- **ガチャ購入状況（KPI）**: ガチャごとの課金人数や課金金額の表示
- **アイテム使用状況（KPI）**: アイテムごとの使用率、所持率等

### ガチャ機能
- **ガチャ履歴画面**: ユーザーが過去に引いたガチャの履歴を表示（結果通知に含まれる？）

---

## 必須にすべき追加機能（推奨）

### 🔴 必須（優先度1に追加推奨）

#### 1. **ガチャ履歴表示（ユーザー側）** ⭐ 高優先度
- **機能**: ユーザーが過去に引いたガチャの履歴を一覧表示
- **詳細**:
  - 抽選日時、ガチャタイプ、獲得アイテムを表示
  - ページネーション対応
  - フィルタリング（ガチャタイプ別、日付範囲）
- **理由**: 
  - ユーザーが自分の獲得履歴を確認できることは基本機能
  - 結果通知だけでは過去の履歴を確認できない
  - データベースに`gacha_histories`テーブルが既に存在するため実装しやすい
- **実装場所**: マイページまたは専用の「抽選履歴」ページ

#### 2. **ガチャシミュレータ（管理機能）** ⭐ 高優先度
- **機能**: 設定したガチャの排出率、景品が正しく設定されているか確認する画面
- **詳細**:
  - 指定回数（例: 1000回、10000回）のガチャをシミュレート
  - 各レアリティの排出率を表示
  - 設定した確率と実際の排出率の差分を表示
  - グラフ表示（オプション）
- **理由**:
  - 確率設定の検証は必須（景品表示法への対応）
  - 設定ミスを事前に発見できる
  - 運営の信頼性確保に不可欠
- **実装場所**: 管理画面の「ガチャ設定」内

#### 3. **基本的なKPI表示（管理機能）** ⭐ 中優先度
- **機能**: 最低限の売上管理機能
- **詳細**:
  - ガチャごとの課金人数、課金金額の表示
  - 日別・月別の集計
  - ガチャタイプ別の集計
- **理由**:
  - ビジネス運営に最低限必要な情報
  - データベースに`gacha_histories`が存在するため実装可能
  - 詳細な分析は後回しでも良いが、基本統計は必要
- **実装場所**: 管理画面の「統計」または「ダッシュボード」ページ

#### 4. **エラーハンドリング・ログ管理** ⭐ 中優先度
- **機能**: エラー発生時の適切な処理とログ記録
- **詳細**:
  - 決済エラー時のリトライ機能
  - ガチャ抽選エラー時のロールバック
  - エラーログの記録（データベースまたはファイル）
  - 管理者へのエラー通知（重大なエラーのみ）
- **理由**:
  - ユーザー体験の向上
  - 問題の早期発見と対応
  - デバッグの効率化
- **実装場所**: アプリケーション全体

#### 5. **管理画面の認証・セキュリティ強化** ⭐ 中優先度
- **機能**: 管理画面へのアクセス制御の強化
- **詳細**:
  - 現在はパスワード認証のみ（要件定義より）
  - セッション管理の強化
  - IP制限（オプション）
  - 操作ログの記録（誰が何を変更したか）
- **理由**:
  - セキュリティリスクの低減
  - 監査証跡の確保
  - 不正操作の検知
- **実装場所**: 管理画面全体

---

### 🟡 検討推奨（優先度2-3）

#### 6. **アイテム使用機能の詳細化**
- **機能**: No.8「アイテム使用」の詳細仕様
- **詳細**:
  - アイテム使用時の確認ダイアログ
  - 使用済みアイテムの表示
  - 使用履歴の記録
- **理由**: 現在の要件が抽象的。具体的な仕様が必要

#### 7. **無料ガチャ管理（管理機能）**
- **機能**: 無料ガチャの付与状況を管理画面で確認
- **詳細**:
  - 友達紹介による無料ガチャ付与状況
  - 使用済み/未使用の一覧
  - 有効期限の管理
- **理由**: 友達紹介システムと連動するため、管理機能として必要

#### 8. **決済履歴管理（管理機能）**
- **機能**: 決済履歴の確認とエラー対応
- **詳細**:
  - Stripe決済履歴の表示
  - 決済エラーの確認
  - 返金処理（必要に応じて）
- **理由**: 決済トラブルの対応に必要

---

## 優先度1に追加すべき機能（推奨）

### 必須追加（優先度1）

1. ✅ **ガチャ履歴表示（ユーザー側）** - No.7「アイテム表示」とは別に必要
2. ✅ **ガチャシミュレータ（管理機能）** - 確率検証のため必須
3. ✅ **基本的なKPI表示（管理機能）** - 最低限の売上管理

### 検討追加（優先度2）

4. ⚠️ **エラーハンドリング・ログ管理** - 運用上重要だが、MVPでは最小限でも可
5. ⚠️ **管理画面の認証・セキュリティ強化** - セキュリティ上重要だが、パスワード認証で一旦可

---

## 更新後の優先度1リスト（推奨）

| No. | 機能分類 | 要件名 | 概要 | 優先度 | 備考 |
|-----|---------|--------|------|--------|------|
| 1 | 基本機能 | LINE登録 | 公式アカウントを各ユーザーの友だちに追加する | 1 | |
| 2 | 基本機能 | メニュー表示 | メニュー画面を表示して、各メニューを選択できる | 1 | |
| 3 | ガチャ機能 | ガチャ選択 | ガチャ一覧を表示する、各ガチャの詳細内容を確認できる | 1 | |
| 4 | 基本機能 | 決済 | ガチャをプレイするための決済機能 | 1 | |
| 5 | ガチャ機能 | ガチャプレイ | ガチャの演出映像を表示する | 1 | |
| 6 | ガチャ機能 | 結果通知 | LINEメッセージでガチャの結果をユーザーに送信する | 1 | |
| 7 | ガチャ機能 | アイテム表示 | ユーザーが所有するアイテムの一覧を表示する | 1 | |
| **7-2** | **ガチャ機能** | **ガチャ履歴表示** | **ユーザーが過去に引いたガチャの履歴を一覧表示する** | **1** | **追加推奨** |
| 8 | ガチャ機能 | アイテム使用 | アイテム詳細からアイテムを使用する | 1 | |
| 9 | 基本機能 | 友だち紹介 | ユーザーが公式アカウントをシェアできる | 1 | |
| 10 | 管理機能 | ユーザー管理 | ユーザー一覧とユーザーの詳細情報を確認できる | 1 | |
| 11 | 管理機能 | ガチャ設定 | 各ガチャの設定ができる | 1 | |
| **11-2** | **管理機能** | **ガチャシミュレータ** | **設定したガチャの排出率、景品が正しく設定されているか確認する画面** | **1** | **追加推奨** |
| 12 | 管理機能 | アイテム設定 | アイテムの情報設定 | 1 | |
| 13 | 管理機能 | メッセージ配信 | 公式アカウントから配信するメッセージの設定 | 1 | |
| **14** | **管理機能** | **KPI表示（基本）** | **ガチャごとの課金人数や課金金額の表示** | **1** | **追加推奨** |

---

## 実装優先順位（2月26日まで）

### Phase 1: コア機能（最優先）
1. LINE登録（No.1）
2. メニュー表示（No.2）
3. ガチャ選択（No.3）
4. 決済（No.4）
5. ガチャプレイ（No.5）
6. 結果通知（No.6）
7. 友だち紹介（No.9）

### Phase 2: ユーザー機能
8. アイテム表示（No.7）
9. **ガチャ履歴表示（No.7-2）** ⭐ 追加
10. アイテム使用（No.8）

### Phase 3: 管理機能（基本）
11. 管理画面認証
12. ユーザー管理（No.10）
13. ガチャ設定（No.11）
14. **ガチャシミュレータ（No.11-2）** ⭐ 追加
15. アイテム設定（No.12）
16. メッセージ配信（No.13）
17. **KPI表示（基本）（No.14）** ⭐ 追加

### Phase 4: 運用・セキュリティ（時間があれば）
18. エラーハンドリング強化
19. ログ管理
20. セキュリティ強化

---

## 結論

### 必須追加（優先度1に追加推奨）

1. **ガチャ履歴表示（ユーザー側）** - ユーザーが自分の履歴を確認できる基本機能
2. **ガチャシミュレータ（管理機能）** - 確率設定の検証は必須（景品表示法対応）
3. **基本的なKPI表示（管理機能）** - 最低限の売上管理は必要

### 検討事項

- **エラーハンドリング・ログ管理**: 重要だが、MVPでは最小限でも可
- **管理画面の認証・セキュリティ強化**: セキュリティ上重要だが、パスワード認証で一旦可

---

## 参考

- [要件定義.md](./要件定義.md)
- [DB物理設計_Layer1.md](./DB物理設計_Layer1.md)
- [景品表示法参考](https://corporate.vbest.jp/columns/9165/)

