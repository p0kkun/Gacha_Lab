# 環境変数の管理方法

## 概要

開発環境（ローカル）と本番環境（AWS）で異なるデータベース接続文字列を使用する方法です。

---

## 📋 環境変数の優先順位（Next.js）

Next.jsでは、以下の順序で環境変数が読み込まれます：

1. `.env.production.local`（本番環境のみ、Gitにコミットしない）
2. `.env.local`（すべての環境、Gitにコミットしない）
3. `.env.production`（本番環境のみ、Gitにコミット可能）
4. `.env.development`（開発環境のみ、Gitにコミット可能）
5. `.env`（すべての環境、Gitにコミット可能）

**重要**: `.local`が付くファイルはGitにコミットしないでください。

---

## 🎯 推奨設定方法

### 方法1: `.env.local`と`.env.production.local`を使い分ける（推奨）

#### `.env.local`（ローカル開発用）

```env
# ローカル開発環境用
NEXT_PUBLIC_LIFF_ID=2008642684-d8jPmggE
NEXT_PUBLIC_ADMIN_PASSWORD=admin

# ローカルPostgreSQL
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/gacha_lab?schema=public"
```

#### `.env.production.local`（本番環境用、Gitにコミットしない）

```env
# 本番環境用（AWS RDS）
DATABASE_URL="postgresql://postgres:GachaLab2024!Secure@gacha-lab-db.cds4guwa0y2c.ap-northeast-1.rds.amazonaws.com:5432/gacha_lab?sslmode=require"
```

**動作**:
- ローカル開発時（`npm run dev`）: `.env.local`の`DATABASE_URL`が使用される
- 本番環境（`npm run build && npm start`）: `.env.production.local`の`DATABASE_URL`が使用される

---

### 方法2: 環境変数で直接指定（デプロイ環境用）

VercelやAWS Amplifyなどのデプロイ環境では、環境変数を直接設定します。

#### Vercelの場合

1. Vercelダッシュボード → プロジェクト → Settings → Environment Variables
2. `DATABASE_URL`を追加
3. 値: `postgresql://postgres:GachaLab2024!Secure@gacha-lab-db.cds4guwa0y2c.ap-northeast-1.rds.amazonaws.com:5432/gacha_lab?sslmode=require`

#### AWS Amplifyの場合

1. Amplify Console → アプリ → Environment variables
2. `DATABASE_URL`を追加
3. 値: `postgresql://postgres:GachaLab2024!Secure@gacha-lab-db.cds4guwa0y2c.ap-northeast-1.rds.amazonaws.com:5432/gacha_lab?sslmode=require`

---

## 📁 ファイル構成の例

```
Gacha_Lab/app/
├── .env                    # 共通設定（Gitにコミット可能）
├── .env.local              # ローカル開発用（Gitにコミットしない）
├── .env.production.local   # 本番環境用（Gitにコミットしない）
└── .gitignore              # .env.localと.env.production.localを含める
```

---

## 🔧 実際の設定手順

### ステップ1: `.env.local`の確認

`.env.local`にローカルDBの接続文字列が設定されていることを確認：

```env
NEXT_PUBLIC_LIFF_ID=2008642684-d8jPmggE
NEXT_PUBLIC_ADMIN_PASSWORD=admin
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/gacha_lab?schema=public"
```

### ステップ2: `.env.production.local`の作成（オプション）

本番環境でローカルからビルドする場合のみ必要：

```env
DATABASE_URL="postgresql://postgres:GachaLab2024!Secure@gacha-lab-db.cds4guwa0y2c.ap-northeast-1.rds.amazonaws.com:5432/gacha_lab?sslmode=require"
```

### ステップ3: `.gitignore`の確認

`.gitignore`に以下が含まれていることを確認：

```
.env.local
.env*.local
```

---

## 🚀 デプロイ時の設定

### Vercelの場合

1. Vercelダッシュボードで環境変数を設定
2. デプロイ時に自動的に使用される

### AWS Amplifyの場合

1. Amplify Consoleで環境変数を設定
2. デプロイ時に自動的に使用される

---

## ✅ 確認方法

### ローカル開発環境

```powershell
npm run dev
```

ローカルPostgreSQLに接続されることを確認。

### 本番環境（Vercel/Amplify）

デプロイ後、AWS RDSに接続されることを確認。

---

## 📝 まとめ

| 環境 | 使用するDATABASE_URL | 設定場所 |
|------|---------------------|---------|
| ローカル開発 | ローカルPostgreSQL | `.env.local` |
| 本番環境（Vercel/Amplify） | AWS RDS | デプロイ環境の環境変数設定 |

**推奨**: 
- ローカル開発: `.env.local`にローカルDBの接続文字列
- 本番環境: デプロイ環境（Vercel/Amplify）の環境変数設定でAWS RDSの接続文字列

---

## 参考

- [Next.js Environment Variables](https://nextjs.org/docs/app/building-your-application/configuring/environment-variables)
- [Vercel Environment Variables](https://vercel.com/docs/concepts/projects/environment-variables)
- [AWS Amplify Environment Variables](https://docs.aws.amazon.com/amplify/latest/userguide/environment-variables.html)

