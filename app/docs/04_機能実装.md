# 機能実装手順

## 実装済み機能

以下の機能は既に実装済みです。参考として実装内容を記載します。

## 1. LIFF SDK統合

### lib/liff.ts

LIFF SDKの初期化とプロフィール取得をラップしたユーティリティ：

```typescript
import liff from '@line/liff';

export type LiffProfile = {
  userId: string;
  displayName: string;
  pictureUrl?: string;
  statusMessage?: string;
};

export const initLiff = async (liffId: string) => { ... };
export const isLoggedIn = (): boolean => { ... };
export const login = () => { ... };
export const getProfile = async (): Promise<LiffProfile> => { ... };
```

### app/page.tsx

メインページでLIFFを初期化し、ユーザー情報を表示：

- LIFF初期化
- ログイン状態の確認
- プロフィール情報の取得・表示
- ガチャモーダルの開閉

## 2. ガチャ機能実装

### app/api/gacha/route.ts

ガチャ抽選API（Next.js API Route）：

- レアリティ抽選（コモン70%、レア25%、エピック5%）
- プレミアムガチャ対応（レアリティ重み変更）
- 抽選結果の返却

**現在の実装**:
- 仮のガチャアイテムデータ（後でデータベースに移行予定）
- すべてのアイテムで`item1.mp4`を使用（他の動画ファイル追加後に変更）

### components/GachaModal.tsx

全画面ガチャモーダル：

- 左側メニュー（ガチャ種類選択）
- 右側メインコンテンツ（ガチャ情報・抽選ボタン）

### components/GachaMenu.tsx

左側メニューコンポーネント：

- ガチャ種類の一覧表示
- 選択中のガチャをハイライト

### components/GachaContent.tsx

右側メインコンテンツ：

- ガチャ情報の表示
- 「ガチャを引く」ボタン
- 抽選結果の表示
- 動画再生のトリガー

## 3. 動画再生機能実装

### components/VideoPlayer.tsx

動画再生コンポーネント：

- 自動再生
- 再生終了時のコールバック
- 全画面表示対応

### public/videos/

動画ファイル配置ディレクトリ：

- `item1.mp4`: サンプル動画（現在すべてのアイテムで使用）
- 将来的に`item2.mp4`～`item5.mp4`を追加予定

## 4. UI実装

### デザイン

- **トーク画面風のUI**: 簡易版のトーク画面風レイアウト
- **全画面オーバーレイ**: ガチャモーダルは全画面で表示
- **左側メニュー**: ガチャ種類選択（1/4幅）
- **右側コンテンツ**: メインコンテンツ（3/4幅）

### Tailwind CSS

- レスポンシブデザイン対応
- モバイルファースト設計

## 実装のポイント

### 1. LIFF初期化のタイミング

`useEffect`内で非同期に初期化：

```typescript
useEffect(() => {
  const initialize = async () => {
    await initLiff(liffId);
    if (!isLoggedIn()) {
      login();
      return;
    }
    const profile = await getProfile();
    setProfile(profile);
  };
  initialize();
}, []);
```

### 2. ガチャ抽選の流れ

1. ユーザーが「ガチャを引く」ボタンをクリック
2. APIにPOSTリクエスト送信
3. サーバー側でレアリティ抽選
4. 抽選結果を返却
5. 動画を再生
6. 動画終了後に結果を表示

### 3. 動画再生の制御

- `autoPlay`: 自動再生
- `playsInline`: インライン再生（iOS対応）
- `onEnded`: 再生終了時のコールバック

## 今後の実装予定

- [ ] データベース連携（抽選履歴の保存）
- [ ] 管理画面の実装（動画アップロード機能）
- [ ] 認証機能の強化
- [ ] エラーハンドリングの改善
- [ ] 追加動画ファイルの配置（item2.mp4～item5.mp4）

## 確認項目

- [ ] LIFF初期化が正常に動作する
- [ ] ユーザー情報が表示される
- [ ] ガチャモーダルが開閉できる
- [ ] ガチャ抽選が正常に動作する
- [ ] 動画が再生される
- [ ] 結果が正しく表示される

## 次のステップ

- [05_ローカル開発環境.md](./05_ローカル開発環境.md) に進む

