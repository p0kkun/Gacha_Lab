# ローカルデータベース構築手順

## 概要

ローカル開発環境で PostgreSQL データベースを構築する手順です。

**対象**: Windows 環境でのローカル開発

---

## 方法 1: PostgreSQL を直接インストール（推奨・Docker 不要）

Docker Desktop は必須ではありません。PostgreSQL を直接インストールする方法が最もシンプルです。

### 1.1 PostgreSQL のインストール

1. [PostgreSQL 公式サイト](https://www.postgresql.org/download/windows/)からインストーラーをダウンロード
2. インストーラーを実行
3. パスワードを設定（例: `postgres`）
4. ポートは`5432`のまま

### 1.2 データベースの作成

```powershell
# PostgreSQLに接続
psql -U postgres

# データベースを作成
CREATE DATABASE gacha_lab;

# 接続を終了
\q
```

### 1.3 環境変数の設定

`.env.local`ファイルに以下を追加：

```env
DATABASE_URL="postgresql://postgres:あなたのパスワード@localhost:5432/gacha_lab?schema=public"
```

---

## 方法 2: Docker を使用（オプション）

### 1.1 Docker のインストール確認

```powershell
docker --version
```

Docker がインストールされていない場合は、[Docker Desktop for Windows](https://www.docker.com/products/docker-desktop)をインストールしてください。

### 1.2 PostgreSQL コンテナの起動

```powershell
docker run --name gacha-lab-postgres `
  -e POSTGRES_PASSWORD=postgres `
  -e POSTGRES_DB=gacha_lab `
  -p 5432:5432 `
  -d postgres:16
```

### 1.3 コンテナの状態確認

```powershell
docker ps
```

### 1.4 接続確認

```powershell
docker exec -it gacha-lab-postgres psql -U postgres -d gacha_lab
```

接続できたら、`\q`で終了します。

---

---

## 3. 環境変数の設定

### 3.1 `.env.local`ファイルに追加

プロジェクトルート（`app/`ディレクトリ）の`.env.local`ファイルに以下を追加：

```env
DATABASE_URL="postgresql://postgres:あなたのパスワード@localhost:5432/gacha_lab?schema=public"
```

**Docker 使用の場合（オプション）:**

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/gacha_lab?schema=public"
```

**⚠️ 注意**: `.env.local`は`.gitignore`に含まれています。Git にコミットしないでください。

---

## 4. Prisma クライアントの生成

```powershell
cd Gacha_Lab/app
npm run db:generate
```

---

## 5. データベースマイグレーション

### 5.1 初回マイグレーション

```powershell
npm run db:migrate
```

または

```powershell
npx prisma migrate dev --name init_layer1
```

このコマンドで以下が実行されます：

1. マイグレーションファイルの生成
2. データベースへのスキーマ適用
3. Prisma クライアントの再生成

### 5.2 マイグレーションファイルの確認

マイグレーションファイルは `prisma/migrations/` ディレクトリに生成されます。

---

## 6. 初期データの投入

### 6.1 tsx のインストール（シードスクリプト実行用）

```powershell
npm install -D tsx
```

### 6.2 シードデータの投入

```powershell
npm run db:seed
```

または

```powershell
npx tsx prisma/seed.ts
```

### 6.3 投入されるデータ

- **ガチャタイプ**: 通常ガチャ、プレミアムガチャ
- **ガチャアイテム**: 1 等〜5 等、ハズレ（サンプル）

---

## 7. データベースの確認

### 7.1 Prisma Studio で確認

```powershell
npm run db:studio
```

ブラウザで `http://localhost:5555` が開き、データベースの内容を確認できます。

### 7.2 直接 SQL で確認（Docker 使用の場合）

```powershell
docker exec -it gacha-lab-postgres psql -U postgres -d gacha_lab
```

```sql
-- テーブル一覧
\dt

-- ガチャタイプの確認
SELECT * FROM gacha_types;

-- ガチャアイテムの確認
SELECT * FROM gacha_items;
```

---

## 8. Docker コンテナの管理

### 8.1 コンテナの停止

```powershell
docker stop gacha-lab-postgres
```

### 8.2 コンテナの起動

```powershell
docker start gacha-lab-postgres
```

### 8.3 コンテナの削除

```powershell
docker stop gacha-lab-postgres
docker rm gacha-lab-postgres
```

**⚠️ 注意**: コンテナを削除すると、データベースのデータも削除されます。

### 8.4 データの永続化（オプション）

データを永続化する場合は、ボリュームマウントを使用：

```powershell
docker run --name gacha-lab-postgres `
  -e POSTGRES_PASSWORD=postgres `
  -e POSTGRES_DB=gacha_lab `
  -p 5432:5432 `
  -v gacha-lab-postgres-data:/var/lib/postgresql/data `
  -d postgres:16
```

---

## 9. トラブルシューティング

### 9.1 マイグレーションエラー

**エラー**: `Error: P1001: Can't reach database server`

**解決方法**:

- PostgreSQL が起動しているか確認（Docker コンテナが起動しているか）
- `DATABASE_URL`が正しいか確認
- ポート 5432 が使用可能か確認

### 9.2 ポートが既に使用されている

**エラー**: `Error: bind: address already in use`

**解決方法**:

- 既存の PostgreSQL インスタンスを停止
- または、別のポートを使用（例: `-p 5433:5432`）

### 9.3 データベースのリセット（開発環境のみ）

```powershell
npx prisma migrate reset
```

**⚠️ 注意**: このコマンドはデータベースを完全にリセットし、すべてのデータを削除します。

---

## 10. 確認項目

- [ ] PostgreSQL が起動している（Docker コンテナまたは直接インストール）
- [ ] `.env.local`に`DATABASE_URL`が設定されている
- [ ] Prisma クライアントが生成されている
- [ ] マイグレーションが正常に完了している
- [ ] すべてのテーブルが作成されている
- [ ] 初期データが投入されている
- [ ] Prisma Studio でデータが確認できる

---

## 11. 次のステップ

- [DB 物理設計\_実装手順.md](../DB物理設計_実装手順.md) で詳細を確認
- ガチャ抽選 API の DB 対応
- 抽選履歴の保存機能
- 友達紹介システムの DB 連携

---

## 参考資料

- [Prisma Documentation](https://www.prisma.io/docs)
- [Prisma Migrate Guide](https://www.prisma.io/docs/guides/migrate)
- [PostgreSQL Docker Hub](https://hub.docker.com/_/postgres)
- [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop)
