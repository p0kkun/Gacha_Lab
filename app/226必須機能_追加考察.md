# 2 月 26 日（Layer 1 MVP）必須機能 - 追加考察

## 概要

既存の要件リストに記載されていないが、2 月 26 日（Layer 1 MVP）までに必須にすべき機能を考察します。

---

## 🔴 必須追加機能（優先度 1 に追加推奨）

### 1. **利用規約・プライバシーポリシー表示** ⭐ 法的必須

- **機能**: ユーザーが利用規約とプライバシーポリシーを確認できる
- **詳細**:
  - 初回利用時の同意取得（チェックボックス）
  - 利用規約・プライバシーポリシーの表示ページ
  - 同意履歴の記録
- **理由**:
  - **法的要件**: 個人情報保護法、特定商取引法への対応
  - ユーザー保護の観点から必須
  - サービス利用の前提条件
- **実装場所**:
  - 初回ログイン時のモーダルまたは専用ページ
  - フッターにリンク
- **備考**: 既に`privacy.html`が存在するが、アプリ内での表示と同意取得が必要

---

### 2. **特定商取引法に基づく表記** ⭐ 法的必須

- **機能**: 特定商取引法に基づく表記を表示
- **詳細**:
  - 事業者名、所在地、連絡先
  - 販売価格、支払い方法
  - 返品・交換の条件
  - 景品表示法に基づく確率表示
- **理由**:
  - **法的要件**: 特定商取引法で義務付けられている
  - 有料サービスを提供する場合、必須
  - ユーザーの信頼性確保
- **実装場所**:
  - 管理画面で設定・編集可能
  - アプリ内の「特定商取引法に基づく表記」ページ
  - 決済画面にリンク

---

### 3. **決済とガチャ抽選のトランザクション管理** ⭐ 技術必須

- **機能**: 決済完了とガチャ抽選の整合性を保証
- **詳細**:
  - 決済完了後にガチャ抽選を実行（現在の要件定義に記載あり）
  - 決済成功したがガチャ抽選が失敗した場合の処理
  - ガチャ抽選成功したが決済が失敗した場合の処理
  - 二重決済防止（冪等性保証）
  - ロールバック機能
- **理由**:
  - **データ整合性**: 決済とガチャ抽選の不整合を防ぐ
  - **ユーザー保護**: 決済したのにアイテムが付与されない問題を防ぐ
  - **ビジネス保護**: ガチャ抽選したのに決済が失敗する問題を防ぐ
- **実装場所**:
  - 決済 API とガチャ抽選 API の統合部分
  - データベーストランザクション管理

---

### 4. **無料ガチャの有効期限・使用状況管理** ⭐ 機能必須

- **機能**: 無料ガチャの有効期限管理と使用状況の確認
- **詳細**:
  - 無料ガチャの有効期限表示（ユーザー側）
  - 有効期限切れの無料ガチャの無効化
  - 使用済み/未使用の無料ガチャ一覧（ユーザー側）
  - 無料ガチャの使用状況確認（管理画面）
- **理由**:
  - 友達紹介システム（No.9）と連動するため必須
  - データベースに`free_gacha_histories`テーブルが存在するが、UI 実装が必要
  - ユーザーが無料ガチャを確認・使用できる必要がある
- **実装場所**:
  - ユーザー側: マイページまたは「無料ガチャ」ページ
  - 管理画面: 無料ガチャ管理ページ

---

### 5. **決済失敗時のエラーハンドリング** ⭐ ユーザー体験必須

- **機能**: 決済失敗時の適切な処理とユーザーへの通知
- **詳細**:
  - 決済失敗時のエラーメッセージ表示
  - 決済失敗の理由表示（カード残高不足、カード期限切れなど）
  - リトライ機能（オプション）
  - 決済失敗履歴の記録（管理画面で確認可能）
- **理由**:
  - ユーザー体験の向上
  - 決済トラブルの早期発見と対応
  - データベースに記録することで分析可能
- **実装場所**:
  - 決済画面
  - 管理画面の「決済履歴」ページ

---

### 6. **API レート制限** ⭐ セキュリティ必須

- **機能**: API への過度なリクエストを制限
- **詳細**:
  - ガチャ抽選 API のレート制限（例: 1 分間に 10 回まで）
  - 決済 API のレート制限
  - 管理画面 API のレート制限
  - IP アドレスまたはユーザー ID ベースの制限
- **理由**:
  - **セキュリティ**: DDoS 攻撃、不正利用の防止
  - **サーバー保護**: 過度な負荷を防ぐ
  - **コスト削減**: 無駄な API 呼び出しを防ぐ
- **実装場所**:
  - API Routes（Next.js）
  - ミドルウェアまたは専用ライブラリ（例: `express-rate-limit`相当）

---

### 7. **ローディング状態の表示** ⭐ UX 必須

- **機能**: 処理中の状態をユーザーに明確に表示
- **詳細**:
  - ガチャ抽選中のローディング表示
  - 決済処理中のローディング表示
  - データ取得中のローディング表示
  - ネットワークエラー時のリトライ表示
- **理由**:
  - ユーザー体験の向上
  - 処理が進行中であることを明確に伝える
  - 二重クリック防止
- **実装場所**:
  - 全画面（ガチャモーダル、決済画面など）

---

### 8. **セッション管理・タイムアウト** ⭐ セキュリティ必須

- **機能**: セッションの有効期限管理とタイムアウト処理
- **詳細**:
  - 管理画面のセッションタイムアウト（例: 30 分）
  - タイムアウト時の自動ログアウト
  - セッション延長機能（オプション）
  - 複数デバイスからの同時ログイン制御（オプション）
- **理由**:
  - **セキュリティ**: セッションハイジャックの防止
  - 管理画面のセキュリティ強化
- **実装場所**:
  - 管理画面全体

---

## 🟡 検討推奨機能（優先度 2-3）

### 9. **データバックアップ・復旧機能**

- **機能**: データベースのバックアップと復旧
- **詳細**:
  - 自動バックアップ（AWS RDS の場合は自動）
  - 手動バックアップ機能（管理画面）
  - バックアップからの復旧手順
- **理由**: データ損失の防止、災害復旧
- **備考**: AWS RDS を使用する場合は自動バックアップが有効

---

### 10. **システム監視・アラート**

- **機能**: システムの異常を検知して管理者に通知
- **詳細**:
  - エラー率の監視
  - レスポンス時間の監視
  - データベース接続エラーの監視
  - 管理者へのメール通知（オプション）
- **理由**: 問題の早期発見と対応
- **備考**: MVP では最小限でも可（ログ確認で代替可能）

---

### 11. **メンテナンスモード**

- **機能**: システムメンテナンス時の表示
- **詳細**:
  - メンテナンスモードの有効/無効切り替え（管理画面）
  - メンテナンス中の表示ページ
  - メンテナンス終了予定時刻の表示
- **理由**: システム更新時のユーザーへの通知
- **備考**: MVP では手動でメンテナンスページを表示する方法でも可

---

### 12. **データエクスポート機能（管理画面）**

- **機能**: 管理画面からデータをエクスポート
- **詳細**:
  - 抽選履歴の CSV エクスポート
  - ユーザー一覧の CSV エクスポート
  - 決済履歴の CSV エクスポート
- **理由**: データ分析、レポート作成
- **備考**: MVP では後回しでも可（Prisma Studio で代替可能）

---

### 13. **CSRF 対策**

- **機能**: クロスサイトリクエストフォージェリ対策
- **詳細**:
  - CSRF トークンの生成と検証
  - 管理画面の操作に対する CSRF 対策
- **理由**: セキュリティ強化
- **備考**: Next.js のデフォルト機能で対応可能

---

### 14. **XSS 対策**

- **機能**: クロスサイトスクリプティング対策
- **詳細**:
  - ユーザー入力のサニタイズ
  - React のデフォルトエスケープ機能の活用
- **理由**: セキュリティ強化
- **備考**: React を使用しているため、基本的には自動で対応されているが、確認が必要

---

### 15. **決済の返金処理（管理画面）**

- **機能**: 決済の返金処理を管理画面から実行
- **詳細**:
  - Stripe の返金 API との連携
  - 返金理由の記録
  - 返金履歴の表示
- **理由**: 決済トラブルの対応
- **備考**: MVP では手動で Stripe ダッシュボードから返金する方法でも可

---

## 📊 優先度別まとめ

### 優先度 1（必須追加）

| No. | 機能名                                 | 分類         | 理由                             |
| --- | -------------------------------------- | ------------ | -------------------------------- |
| 1   | 利用規約・プライバシーポリシー表示     | 法的         | 個人情報保護法、特定商取引法対応 |
| 2   | 特定商取引法に基づく表記               | 法的         | 特定商取引法で義務付けられている |
| 3   | 決済とガチャ抽選のトランザクション管理 | 技術         | データ整合性、ユーザー保護       |
| 4   | 無料ガチャの有効期限・使用状況管理     | 機能         | 友達紹介システムと連動           |
| 5   | 決済失敗時のエラーハンドリング         | UX           | ユーザー体験向上                 |
| 6   | API レート制限                         | セキュリティ | DDoS 攻撃、不正利用の防止        |
| 7   | ローディング状態の表示                 | UX           | ユーザー体験向上                 |
| 8   | セッション管理・タイムアウト           | セキュリティ | セキュリティ強化                 |

### 優先度 2-3（検討推奨）

| No. | 機能名                       | 分類         | 備考                               |
| --- | ---------------------------- | ------------ | ---------------------------------- |
| 9   | データバックアップ・復旧機能 | 運用         | AWS RDS の場合は自動               |
| 10  | システム監視・アラート       | 運用         | MVP では最小限でも可               |
| 11  | メンテナンスモード           | 運用         | 手動でも可                         |
| 12  | データエクスポート機能       | 運用         | Prisma Studio で代替可能           |
| 13  | CSRF 対策                    | セキュリティ | Next.js のデフォルト機能で対応可能 |
| 14  | XSS 対策                     | セキュリティ | React のデフォルト機能で対応可能   |
| 15  | 決済の返金処理               | 運用         | Stripe ダッシュボードで代替可能    |

---

## 実装優先順位（2 月 26 日まで）

### Phase 1: 法的・コンプライアンス（最優先）

1. ✅ **利用規約・プライバシーポリシー表示** - 法的必須
2. ✅ **特定商取引法に基づく表記** - 法的必須

### Phase 2: 技術的必須（高優先度）

3. ✅ **決済とガチャ抽選のトランザクション管理** - データ整合性
4. ✅ **API レート制限** - セキュリティ
5. ✅ **セッション管理・タイムアウト** - セキュリティ

### Phase 3: 機能必須（中優先度）

6. ✅ **無料ガチャの有効期限・使用状況管理** - 友達紹介システム連動
7. ✅ **決済失敗時のエラーハンドリング** - UX
8. ✅ **ローディング状態の表示** - UX

### Phase 4: 運用・セキュリティ（時間があれば）

9. ⚠️ データバックアップ・復旧機能
10. ⚠️ システム監視・アラート
11. ⚠️ メンテナンスモード
12. ⚠️ その他（CSRF、XSS、返金処理など）

---

## 結論

### 必須追加（優先度 1 に追加推奨）

**法的必須（2 つ）:**

1. **利用規約・プライバシーポリシー表示** - 個人情報保護法、特定商取引法対応
2. **特定商取引法に基づく表記** - 有料サービス提供時の法的義務

**技術必須（3 つ）:** 3. **決済とガチャ抽選のトランザクション管理** - データ整合性、ユーザー保護 4. **API レート制限** - セキュリティ、サーバー保護 5. **セッション管理・タイムアウト** - セキュリティ強化

**機能必須（3 つ）:** 6. **無料ガチャの有効期限・使用状況管理** - 友達紹介システム連動 7. **決済失敗時のエラーハンドリング** - ユーザー体験向上 8. **ローディング状態の表示** - ユーザー体験向上

**合計: 8 つの機能を優先度 1 に追加推奨**

---

## 参考

- [要件定義.md](./要件定義.md)
- [226 必須機能\_追加検討.md](./226必須機能_追加検討.md)
- [特定商取引法](https://www.meti.go.jp/policy/economy/consumer/trade/transactions.html)
- [個人情報保護法](https://www.ppc.go.jp/personalinfo/)
