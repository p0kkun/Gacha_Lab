# LINE ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥å®Ÿè£…æ–¹æ³•

## æ¦‚è¦

å•†å“è¿½åŠ ãªã©ã®é€šçŸ¥ã‚’ LINE ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§é€ä¿¡ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

---

## å®Ÿè£…æ–¹æ³•

### 1. LINE Messaging API ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### âš ï¸ é‡è¦ï¼š2024 å¹´ 9 æœˆ 4 æ—¥ä»¥é™ã®å¤‰æ›´

**2024 å¹´ 9 æœˆ 4 æ—¥ä»¥é™ã€LINE Developers ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç›´æ¥ Messaging API ãƒãƒ£ãƒãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨ã¯ã§ããªããªã‚Šã¾ã—ãŸã€‚**

æ–°ã—ã„æ‰‹é †ï¼š

1. **LINE å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ**
2. **LINE Official Account Manager ã‹ã‚‰ Messaging API ã‚’æœ‰åŠ¹åŒ–**

#### å¿…è¦ãªæº–å‚™

1. **LINE å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ**

   - [LINE Official Account Manager](https://account.line.biz/)ã«ã‚¢ã‚¯ã‚»ã‚¹
   - æ–°ã—ã„ LINE å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
   - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã€èª¬æ˜ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãªã©ã‚’è¨­å®š

   **ğŸ“Œ è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã«ã¤ã„ã¦ï¼š**

   - **1 ã¤ã® LINE ãƒ“ã‚¸ãƒã‚¹ ID ã«ã¤ãã€æœ€å¤§ 100 å€‹ã¾ã§ä½œæˆå¯èƒ½**ï¼ˆç„¡æ–™ï¼‰
   - åº—èˆ—ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ†ã‘ã¦é‹ç”¨å¯èƒ½
   - å„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ã«æœˆ 200 é€šã¾ã§ç„¡æ–™ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡å¯èƒ½
   - è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã¤ã“ã¨ã§ç·é…ä¿¡æ•°ã‚’å¢—ã‚„ã™ã“ã¨ãŒå¯èƒ½
   - ãŸã ã—ã€ç®¡ç†ã®è¤‡é›‘åŒ–ã‚„å„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®å‹ã ã¡é›†ã‚ã®æ‰‹é–“ãŒå¢—ãˆã‚‹ç‚¹ã«æ³¨æ„

   **âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã®å¤‰æ›´ã«ã¤ã„ã¦ï¼š**

   - **æœªèªè¨¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: å¤‰æ›´å¯èƒ½ï¼ˆå¤‰æ›´å¾Œ 7 æ—¥é–“ã¯å†åº¦å¤‰æ›´ä¸å¯ï¼‰
   - **èªè¨¼æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: åŸå‰‡ã¨ã—ã¦å¤‰æ›´ä¸å¯ï¼ˆä¼æ¥­åå¤‰æ›´ãªã©æ­£å½“ãªç†ç”±ãŒã‚ã‚‹å ´åˆã¯å†å¯©æŸ»ã§å¤‰æ›´å¯èƒ½ï¼‰
   - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã¯æ…é‡ã«æ±ºã‚ã‚‹ã“ã¨ã‚’æ¨å¥¨

2. **Messaging API ã®æœ‰åŠ¹åŒ–**

   - LINE Official Account Manager ã«ãƒ­ã‚°ã‚¤ãƒ³
   - ä½œæˆã—ãŸå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠ
   - ã€Œè¨­å®šã€â†’ã€ŒMessaging APIã€ã«ç§»å‹•
   - ã€ŒMessaging API ã‚’åˆ©ç”¨ã™ã‚‹ã€ã‚’æœ‰åŠ¹åŒ–
   - ã“ã‚Œã«ã‚ˆã‚Šã€LINE Developers Console ã« Messaging API ãƒãƒ£ãƒãƒ«ãŒè‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™

3. **LINE Developers Console ã§ã®è¨­å®š**

   - [LINE Developers Console](https://developers.line.biz/console/)ã«ã‚¢ã‚¯ã‚»ã‚¹
   - ä½œæˆã•ã‚ŒãŸ Messaging API ãƒãƒ£ãƒãƒ«ã‚’ç¢ºèª
   - **Channel Access Token ã‚’å–å¾—**
     - ã€ŒMessaging APIã€ã‚¿ãƒ– â†’ ã€Œãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€â†’ã€Œç™ºè¡Œã€
   - **Channel Secret ã‚’ç¢ºèª**
     - ã€ŒåŸºæœ¬è¨­å®šã€ã‚¿ãƒ– â†’ ã€Œãƒãƒ£ãƒãƒ«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã€
   - **Webhook URL ã‚’è¨­å®š**ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
     - ã€ŒMessaging APIã€ã‚¿ãƒ– â†’ ã€ŒWebhook URLã€â†’ã€Œç·¨é›†ã€

4. **ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**
   ```env
   LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token
   LINE_CHANNEL_SECRET=your_channel_secret
   ```

#### å‚è€ƒãƒªãƒ³ã‚¯

- [LINE Official Account Manager](https://account.line.biz/)
- [LINE Developers Console](https://developers.line.biz/console/)
- [Messaging API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developers.line.biz/ja/docs/messaging-api/)

#### å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª

```bash
npm install @line/bot-sdk
```

---

### 2. ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰

#### å®Ÿè£…ä¾‹ï¼šå•†å“è¿½åŠ é€šçŸ¥

```typescript
// lib/line-messaging.ts
import { Client, Message } from "@line/bot-sdk";

const client = new Client({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN!,
});

/**
 * å•†å“è¿½åŠ é€šçŸ¥ã‚’é€ä¿¡
 */
export async function sendProductAddedNotification(
  userId: string,
  productName: string,
  productUrl?: string
) {
  try {
    const messages: Message[] = [
      {
        type: "text",
        text: `ğŸ‰ æ–°å•†å“ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼\n\n${productName}\n\nã‚¬ãƒãƒ£ã‚’å¼•ã„ã¦ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼`,
      },
    ];

    // URLãŒã‚ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ 
    if (productUrl) {
      messages.push({
        type: "template",
        altText: "æ–°å•†å“ã®è©³ç´°",
        template: {
          type: "buttons",
          thumbnailImageUrl: "https://example.com/product-image.jpg", // å•†å“ç”»åƒURL
          title: "æ–°å•†å“è¿½åŠ ",
          text: productName,
          actions: [
            {
              type: "uri",
              label: "ã‚¢ãƒ—ãƒªã‚’é–‹ã",
              uri: productUrl,
            },
          ],
        },
      });
    }

    await client.pushMessage(userId, messages);
    return { success: true };
  } catch (error) {
    console.error("LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
    throw error;
  }
}

/**
 * è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸€æ–‰é€ä¿¡ï¼ˆãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆï¼‰
 */
export async function broadcastProductAddedNotification(
  productName: string,
  productUrl?: string
) {
  try {
    const messages: Message[] = [
      {
        type: "text",
        text: `ğŸ‰ æ–°å•†å“ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼\n\n${productName}\n\nã‚¬ãƒãƒ£ã‚’å¼•ã„ã¦ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼`,
      },
    ];

    if (productUrl) {
      messages.push({
        type: "template",
        altText: "æ–°å•†å“ã®è©³ç´°",
        template: {
          type: "buttons",
          thumbnailImageUrl: "https://example.com/product-image.jpg",
          title: "æ–°å•†å“è¿½åŠ ",
          text: productName,
          actions: [
            {
              type: "uri",
              label: "ã‚¢ãƒ—ãƒªã‚’é–‹ã",
              uri: productUrl,
            },
          ],
        },
      });
    }

    await client.broadcast(messages);
    return { success: true };
  } catch (error) {
    console.error("LINEãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
    throw error;
  }
}
```

---

### 3. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ

#### å•†å“è¿½åŠ æ™‚ã«é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ API

```typescript
// app/api/admin/products/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { broadcastProductAddedNotification } from "@/lib/line-messaging";

export async function POST(request: NextRequest) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
    // ...

    const body = await request.json();
    const { name, rarity, videoUrl } = body;

    // å•†å“ã‚’è¿½åŠ 
    const product = await prisma.gachaItem.create({
      data: {
        name,
        rarity,
        videoUrl,
        isActive: true,
      },
    });

    // é€šçŸ¥ã‚’é€ä¿¡ï¼ˆéåŒæœŸã§å®Ÿè¡Œï¼‰
    const liffUrl = process.env.NEXT_PUBLIC_LIFF_URL;
    const productUrl = liffUrl ? `${liffUrl}?product=${product.id}` : undefined;

    // éåŒæœŸã§é€ä¿¡ï¼ˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å•†å“è¿½åŠ ã¯æˆåŠŸã¨ã™ã‚‹ï¼‰
    broadcastProductAddedNotification(product.name, productUrl).catch(
      (error) => {
        console.error("é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆå•†å“è¿½åŠ ã¯æˆåŠŸï¼‰:", error);
      }
    );

    return NextResponse.json({
      success: true,
      product,
    });
  } catch (error) {
    console.error("å•†å“è¿½åŠ ã‚¨ãƒ©ãƒ¼:", error);
    return NextResponse.json(
      { error: "å•†å“ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ" },
      { status: 500 }
    );
  }
}
```

---

### 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã®å–å¾—ã¨ä¿å­˜

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã‚’ä¿å­˜

```typescript
// app/api/users/register/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { userId, displayName, pictureUrl } = body;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã¾ãŸã¯æ›´æ–°
    await prisma.user.upsert({
      where: { userId },
      update: {
        displayName,
        pictureUrl,
        updatedAt: new Date(),
      },
      create: {
        userId,
        displayName,
        pictureUrl,
      },
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error);
    return NextResponse.json(
      { error: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ" },
      { status: 500 }
    );
  }
}
```

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²

```typescript
// app/page.tsx ãªã©
useEffect(() => {
  const registerUser = async () => {
    if (profile) {
      try {
        await fetch("/api/users/register", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl,
          }),
        });
      } catch (error) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error);
      }
    }
  };

  registerUser();
}, [profile]);
```

---

### 5. é€šçŸ¥é€ä¿¡ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

#### å•†å“è¿½åŠ æ™‚ã®é€šçŸ¥

```typescript
// ç®¡ç†ç”»é¢ã§å•†å“ã‚’è¿½åŠ ã—ãŸæ™‚
const handleAddProduct = async (productData: ProductData) => {
  // 1. å•†å“ã‚’è¿½åŠ 
  const response = await fetch("/api/admin/products", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(productData),
  });

  if (response.ok) {
    // é€šçŸ¥ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•é€ä¿¡ã•ã‚Œã‚‹
    alert("å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚");
  }
};
```

#### ãã®ä»–ã®é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°

```typescript
// lib/line-messaging.ts ã«è¿½åŠ 

/**
 * ã‚¬ãƒãƒ£çµæœé€šçŸ¥
 */
export async function sendGachaResultNotification(
  userId: string,
  itemName: string,
  rarity: string
) {
  const rarityEmoji = {
    epic: "ğŸ’œ",
    rare: "ğŸ’™",
    common: "âšª",
  };

  await client.pushMessage(userId, {
    type: "text",
    text: `ğŸŠ ã‚¬ãƒãƒ£çµæœ\n\n${
      rarityEmoji[rarity] || "âšª"
    } ${itemName}\n\nãƒ¬ã‚¢ãƒªãƒ†ã‚£: ${rarity}`,
  });
}

/**
 * å‹é”ç´¹ä»‹æˆç«‹é€šçŸ¥
 */
export async function sendReferralCompletedNotification(
  referrerId: string,
  refereeName: string
) {
  await client.pushMessage(referrerId, {
    type: "text",
    text: `ğŸ‰ å‹é”ç´¹ä»‹ãŒæˆç«‹ã—ã¾ã—ãŸï¼\n\n${refereeName}ã•ã‚“ãŒã‚¢ãƒ—ãƒªã‚’å§‹ã‚ã¾ã—ãŸã€‚\n\nç„¡æ–™ã‚¬ãƒãƒ£ãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸï¼`,
  });
}
```

---

### 6. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç¨®é¡

#### ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

```typescript
{
  type: 'text',
  text: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹',
}
```

#### ãƒœã‚¿ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```typescript
{
  type: 'template',
  altText: 'ä»£æ›¿ãƒ†ã‚­ã‚¹ãƒˆ',
  template: {
    type: 'buttons',
    thumbnailImageUrl: 'https://example.com/image.jpg',
    title: 'ã‚¿ã‚¤ãƒˆãƒ«',
    text: 'æœ¬æ–‡',
    actions: [
      {
        type: 'uri',
        label: 'ã‚¢ãƒ—ãƒªã‚’é–‹ã',
        uri: 'https://liff.line.me/YOUR_LIFF_ID',
      },
      {
        type: 'postback',
        label: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',
        data: 'action=open',
      },
    ],
  },
}
```

#### ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆè¤‡æ•°å•†å“ã®ç´¹ä»‹ï¼‰

```typescript
{
  type: 'template',
  altText: 'æ–°å•†å“ä¸€è¦§',
  template: {
    type: 'carousel',
    columns: [
      {
        thumbnailImageUrl: 'https://example.com/product1.jpg',
        title: 'å•†å“1',
        text: 'å•†å“1ã®èª¬æ˜',
        actions: [
          {
            type: 'uri',
            label: 'è©³ç´°ã‚’è¦‹ã‚‹',
            uri: 'https://liff.line.me/YOUR_LIFF_ID?product=1',
          },
        ],
      },
      {
        thumbnailImageUrl: 'https://example.com/product2.jpg',
        title: 'å•†å“2',
        text: 'å•†å“2ã®èª¬æ˜',
        actions: [
          {
            type: 'uri',
            label: 'è©³ç´°ã‚’è¦‹ã‚‹',
            uri: 'https://liff.line.me/YOUR_LIFF_ID?product=2',
          },
        ],
      },
    ],
  },
}
```

---

### 7. é€šçŸ¥é€ä¿¡ã®åˆ¶é™ã¨æ³¨æ„äº‹é …

#### é€ä¿¡åˆ¶é™

- **ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹ã ã¡è¿½åŠ ã¾ãŸã¯ Webhook çµŒç”±ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸ 24 æ™‚é–“ä»¥å†…ã®ã¿é€ä¿¡å¯èƒ½
- **ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ**: æœˆé–“é€ä¿¡æ•°ã«åˆ¶é™ã‚ã‚Šï¼ˆãƒ—ãƒ©ãƒ³ã«ã‚ˆã‚‹ï¼‰

#### 24 æ™‚é–“åˆ¶é™ã®å›é¿æ–¹æ³•

1. **ãƒªãƒ—ãƒ©ã‚¤ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨**

   - Webhook ã§å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒªãƒ—ãƒ©ã‚¤ã™ã‚‹å ´åˆã¯ 24 æ™‚é–“åˆ¶é™ãªã—

2. **é€šçŸ¥ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‹ã ã¡è¿½åŠ ã‚’ä¿ƒã™**

   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ ã—ã¦ã‚‚ã‚‰ã†
   - å‹ã ã¡è¿½åŠ å¾Œã¯ 24 æ™‚é–“åˆ¶é™ãªã—ã§ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡å¯èƒ½

3. **å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ´»ç”¨**
   - LINE å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ã‚’ä½¿ç”¨

#### å®Ÿè£…ä¾‹ï¼šå‹ã ã¡è¿½åŠ ãƒã‚§ãƒƒã‚¯

```typescript
// lib/line-messaging.ts
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹ã ã¡è¿½åŠ ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
 */
export async function checkUserFollowStatus(userId: string): Promise<boolean> {
  try {
    const profile = await client.getProfile(userId);
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå–å¾—ã§ãã‚Œã°å‹ã ã¡è¿½åŠ æ¸ˆã¿
    return true;
  } catch (error: any) {
    if (error.statusCode === 404) {
      // å‹ã ã¡è¿½åŠ ã•ã‚Œã¦ã„ãªã„
      return false;
    }
    throw error;
  }
}

/**
 * å‹ã ã¡è¿½åŠ ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ24æ™‚é–“ä»¥å†…ã«é€ä¿¡ï¼‰
 */
export async function promptFollowNotification(userId: string) {
  await client.pushMessage(userId, {
    type: "text",
    text: "ğŸ“¢ æ–°å•†å“æƒ…å ±ã‚„ãŠå¾—ãªæƒ…å ±ã‚’ãŠå±Šã‘ã—ã¾ã™ï¼\n\nå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ ã—ã¦ãã ã•ã„ ğŸ‘‡",
  });
}
```

---

### 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
// lib/line-messaging.ts
export async function sendNotificationSafely(userId: string, message: Message) {
  try {
    await client.pushMessage(userId, message);
    return { success: true };
  } catch (error: any) {
    // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ã¦å‡¦ç†
    if (error.statusCode === 404) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹ã ã¡è¿½åŠ ã‚’è§£é™¤ã—ãŸ
      console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã¯å‹ã ã¡è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“`);
      return { success: false, reason: "not_following" };
    } else if (error.statusCode === 429) {
      // ãƒ¬ãƒ¼ãƒˆåˆ¶é™
      console.log("ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸ");
      return { success: false, reason: "rate_limit" };
    } else {
      console.error("é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
      return { success: false, reason: "unknown" };
    }
  }
}
```

---

### 9. å®Ÿè£…ã®æµã‚Œ

1. **LINE å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ** â­ æ–°è¦æ‰‹é †

   - [LINE Official Account Manager](https://account.line.biz/)ã§å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
   - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’è¨­å®š

2. **Messaging API ã®æœ‰åŠ¹åŒ–** â­ æ–°è¦æ‰‹é †

   - LINE Official Account Manager ã§ Messaging API ã‚’æœ‰åŠ¹åŒ–
   - ã“ã‚Œã«ã‚ˆã‚Š LINE Developers Console ã«ãƒãƒ£ãƒãƒ«ãŒè‡ªå‹•ä½œæˆã•ã‚Œã‚‹

3. **LINE Developers Console ã§è¨­å®š**

   - ä½œæˆã•ã‚ŒãŸ Messaging API ãƒãƒ£ãƒãƒ«ã‚’ç¢ºèª
   - Channel Access Token ã‚’ç™ºè¡Œ
   - Channel Secret ã‚’ç¢ºèª
   - Webhook URL ã‚’è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

4. **ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**

   - `.env.local`ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š

   ```env
   LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token
   LINE_CHANNEL_SECRET=your_channel_secret
   ```

5. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**

   - `@line/bot-sdk`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

   ```bash
   npm install @line/bot-sdk
   ```

6. **é€šçŸ¥é€ä¿¡æ©Ÿèƒ½ã®å®Ÿè£…**

   - `lib/line-messaging.ts`ã‚’ä½œæˆ
   - å„ç¨®é€šçŸ¥é–¢æ•°ã‚’å®Ÿè£…

7. **å•†å“è¿½åŠ  API ã«çµ±åˆ**

   - å•†å“è¿½åŠ æ™‚ã«é€šçŸ¥ã‚’é€ä¿¡

8. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½ã®å®Ÿè£…**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
   - é€šçŸ¥é€ä¿¡å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ç®¡ç†

---

## ã¾ã¨ã‚

LINE ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ã¯ä»¥ä¸‹ã®æ–¹æ³•ã§å®Ÿç¾å¯èƒ½ï¼š

1. **LINE Messaging API ã‚’ä½¿ç”¨**ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰é€ä¿¡ï¼‰
2. **ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**ï¼šå€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡
3. **ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ**ï¼šå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸€æ–‰é€ä¿¡
4. **24 æ™‚é–“åˆ¶é™**ï¼šå‹ã ã¡è¿½åŠ å¾Œã¯åˆ¶é™ãªã—
5. **ãƒªãƒƒãƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**ï¼šãƒ†ã‚­ã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ã€ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ãªã©

è©³ç´°ã¯ [LINE Messaging API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developers.line.biz/ja/docs/messaging-api/) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
