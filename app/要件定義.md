# ポーカーガチャプラットフォーム 要件定義

## 1. 概要

LINE LIFF アプリとして動作するポーカーガチャプラットフォーム。ユーザーは LINE のトーク画面からアクセスし、ガチャを引いてポーカーイベントのクーポンやバウチャーを獲得できる。

**リリース目標**: 2025 年 2 月 26 日（Layer 1: ガチャ基盤 MVP）

**参考**: L ガチャのような基本構造を設計

---

## 2. ユーザー

### 2.1 エンドユーザー（LINE ユーザー）

- LINE アカウントを持つユーザー
- LINE のトーク画面からアプリにアクセス
- ガチャを引いてアイテムを獲得

### 2.2 管理者

- 管理画面にアクセス可能なユーザー
- ガチャアイテムの管理
- ガチャタイプの設定
- 抽選履歴の確認

---

## 3. 機能要件

### 3.1 Layer 1: ガチャ基盤（MVP / 2 月 26 日必須機能）

ポーカーガチャの核となる"回せる仕組み"をつくるフェーズ。

#### 3.1.1 LINE ログインでユーザー識別 ⭐ 必須

- **機能**: LINE LIFF SDK を使用したユーザー認証
- **詳細**:
  - LINE アカウントで自動ログイン
  - ユーザー ID、表示名、プロフィール画像を取得
  - 未ログイン時は自動でログイン画面にリダイレクト
  - ユーザー識別による抽選履歴の管理

#### 3.1.2 商品ページ（カード UI）でガチャ選択 ⭐ 必須

- **機能**: カードタイプの UI でガチャ商品を表示・選択
- **詳細**:
  - 商品ページをカード UI で表示
  - ガチャタイプの選択（通常ガチャ、プレミアムガチャなど）
  - 各ガチャの説明と当選商品の表示
  - 参考: L ガチャのような基本構造

#### 3.1.3 決済（Stripe/Chaty） ⭐ 必須

- **機能**: ガチャ引くための決済処理
- **詳細**:
  - Stripe または Chaty を使用した決済
  - **Stripe テストモードを使用**（デモ環境では実際の決済は発生しない）
  - テストカードでシミュレーション可能
  - 決済完了後にガチャ抽選を実行
  - 決済エラーハンドリング
  - 無料ガチャがある場合は決済をスキップ

#### 3.1.4 ガチャ演出 ⭐ 必須

- **機能**: 抽選結果の演出動画を全画面で再生
- **詳細**:
  - 動画再生中は左メニューとヘッダーを非表示
  - 動画をクリックで「スキップする」ボタン表示
  - もう一度クリック（またはボタンクリック）でスキップ
  - 動画終了後、結果を表示
  - 期待値がわかる演出（ハンドレンジ強弱、好きなカードを選んでね）

#### 3.1.5 当選結果付与 ⭐ 必須

- **機能**: 獲得アイテムの情報を表示・付与
- **詳細**:
  - 当選商品の表示
  - 当選商品の種類:
    - **1 等**: MAIN EVENT 無料 voucher
    - **2 等**: INVITATION 無料 voucher
    - **3 等**: 5000 円 OFF voucher
    - **4 等**: 3000 円 OFF voucher
    - **5 等**: 1000 円 OFF voucher
    - **ハズレ**: なし
  - レアリティに応じた色分け表示
  - バウチャー・クーポンの付与処理

#### 3.1.6 敗者復活ガチャ（タグ制御） ⭐ 必須

- **機能**: ハズレ時の敗者復活ガチャ機能
- **詳細**:
  - ハズレ時に敗者復活ガチャを提供
  - タグ制御による条件分岐
  - 敗者復活ガチャの抽選処理

#### 3.1.7 友達紹介システム（1 回ガチャ無料） ⭐ 必須

- **機能**: 友達紹介による無料ガチャ提供
- **詳細**:

  - 友達紹介リンクの生成
  - **紹介リンクの共有方法**:
    - リンク送信（LINE アプリ内シェア、クリップボードコピー）
    - **QR コード生成と表示**（新規追加）
      - QR コードを生成して表示
      - 友達が QR コードを読み取ることで紹介要件を満たす
      - QR コード画像の保存機能
  - 紹介された友達が登録・初回ガチャ実行時に、紹介者と被紹介者の両方に 1 回無料ガチャを付与
  - 紹介履歴の管理
  - **重要**: 1 回ガチャ無料は絶対に入れる

- **不正防止対策**:

  - **同一ユーザーへの重複紹介の防止**

    - 紹介者と被紹介者の組み合わせをデータベースで管理
    - 既に紹介済みの組み合わせは無効とする
    - 1 つの紹介リンクは 1 人の被紹介者にのみ有効

  - **自己紹介の防止**

    - 紹介者が自分自身の紹介リンクを使用した場合、無効とする
    - 紹介者 ID と被紹介者 ID が同一の場合を検知

  - **紹介回数の制限**

    - 1 人の紹介者が獲得できる無料ガチャの上限を設定（例: 月 10 回まで）
    - 被紹介者が獲得できる無料ガチャは初回 1 回のみ

  - **同一デバイス/IP からの大量紹介の検知**

    - 同一 IP アドレスから短時間に大量の紹介が発生した場合、アラートを発する
    - 同一デバイス情報（User-Agent、デバイス ID など）からの異常な紹介パターンを検知
    - 疑わしい紹介は手動審査対象とする

  - **紹介リンクの有効期限**

    - 紹介リンクに有効期限を設定（例: 生成から 30 日間）
    - 期限切れのリンクは無効とする

  - **紹介の検証**

    - 被紹介者が実際に LINE アプリに登録・ログインしたことを確認
    - 被紹介者が初回ガチャを実行した時点で紹介成立とする
    - 紹介成立まで紹介者への無料ガチャ付与は保留

  - **不正行為の検知と対応**

    - 不正が検知された場合、該当する紹介を無効化
    - 悪質な不正行為を行ったユーザーはアカウント停止の対象
    - 不正検知ログを記録し、管理者が確認可能にする

  - **データベース設計**
    - 紹介履歴テーブルに以下を記録:
      - 紹介者 ID
      - 被紹介者 ID
      - 紹介リンク ID（一意）
      - 紹介日時
      - 紹介成立日時
      - IP アドレス
      - デバイス情報
      - 紹介ステータス（保留、成立、無効、不正検知）
      - 無料ガチャ付与状況

---

### 3.2 ユーザー向け機能（既存実装）

#### 3.2.1 メインページ

- **機能**: トーク画面風の UI
- **詳細**:
  - ユーザー情報の表示（プロフィール画像、表示名、ユーザー ID）
  - ガチャ説明文の表示
  - 下部メニューエリア（画面の 1/3）
    - メニューは開閉式
    - 8 個のボタン（上 4 個、下 4 個）
    - ガチャボタンは上段の 2 番目に配置

---

### 3.2 管理画面機能

#### 3.2.1 認証

- **機能**: パスワード認証
- **詳細**:
  - パスワード入力でログイン
  - セッション管理（ブラウザのセッションストレージ）
  - 環境変数でパスワード設定可能

#### 3.2.2 ガチャアイテム管理

- **機能**: ガチャアイテムの CRUD 操作
- **詳細**:
  - 一覧表示（レアリティ別フィルタリング可能）
  - 追加（アイテム名、レアリティ、動画ファイル）
  - 編集（アイテム名、レアリティ、動画ファイルの変更）
  - 削除（論理削除、isActive フラグで制御）
  - 有効/無効の切り替え
  - **商品追加時の通知送信**（新規追加）
    - 商品追加時に全ユーザーに LINE メッセージで通知
    - 通知メッセージに商品名とアプリへのリンクを含める
    - ボタンテンプレートでアプリを開くボタンを表示

#### 3.2.3 ガチャタイプ管理

- **機能**: ガチャタイプの設定
- **詳細**:
  - 一覧表示
  - ガチャ名、説明文の編集
  - レアリティ別の確率設定（合計 100%になるよう制約）
  - 有効/無効の切り替え

#### 3.2.4 抽選履歴管理

- **機能**: 抽選履歴の確認と統計
- **詳細**:
  - 一覧表示（ページネーション対応）
  - フィルタリング（ユーザー ID、ガチャタイプ、日付範囲）
  - 統計表示
    - 総抽選数
    - レアリティ別集計
    - ガチャタイプ別集計
    - 日別集計

---

## 4. 非機能要件

### 4.1 パフォーマンス

- ガチャ抽選 API の応答時間: 1 秒以内
- 動画の読み込み時間: 3 秒以内（ネットワーク状況による）

### 4.2 セキュリティ

- 管理画面はパスワード認証必須
- 環境変数で機密情報を管理
- SQL インジェクション対策（Prisma 使用）

### 4.3 可用性

- エラーハンドリングの実装
- ユーザーフレンドリーなエラーメッセージ

### 4.4 保守性

- TypeScript で型安全性を確保
- コードの可読性と再利用性

---

## 5. 技術要件

### 5.1 フロントエンド

- **フレームワーク**: Next.js 16 (App Router)
- **言語**: TypeScript
- **UI**: React 19
- **スタイリング**: Tailwind CSS 4
- **LINE 連携**: LINE LIFF SDK
- **QR コード生成**: qrcode
- **QR コード読み取り**: html5-qrcode

### 5.2 バックエンド

- **API**: Next.js API Routes
- **データベース**: PostgreSQL
- **ORM**: Prisma
- **言語**: TypeScript
- **LINE Messaging API**: `@line/bot-sdk`（通知送信用）
- **決済**: Stripe（`@stripe/stripe-js`, `@stripe/react-stripe-js`, `stripe`）

### 5.3 データベース

- **RDBMS**: PostgreSQL
- **モデル**:
  - GachaItem（ガチャアイテム）
  - GachaType（ガチャタイプ）
  - GachaHistory（抽選履歴）
  - User（ユーザー、将来的な拡張用）

詳細は `DB_DESIGN.md` を参照

### 5.4 デプロイ

- **推奨**: Vercel
- **その他**: 対応可能なホスティングサービス

---

## 6. データ要件

### 6.1 ガチャアイテム（当選商品）

- アイテム名（必須）
- レアリティ（1 等、2 等、3 等、4 等、5 等、ハズレ）
- 動画ファイル（MP4 形式）
- 有効/無効フラグ
- バウチャー・クーポン情報
  - **1 等**: MAIN EVENT 無料 voucher
  - **2 等**: INVITATION 無料 voucher
  - **3 等**: 5000 円 OFF voucher
  - **4 等**: 3000 円 OFF voucher
  - **5 等**: 1000 円 OFF voucher
  - **ハズレ**: なし（敗者復活ガチャへ誘導）

### 6.2 ガチャタイプ

- ガチャタイプ ID（文字列、例: 'normal', 'premium'）
- ガチャ名
- 説明文
- レアリティ別確率（合計 100%）

### 6.3 抽選履歴

- ユーザー ID（LINE ユーザー ID）
- ガチャタイプ ID
- 獲得アイテム ID
- 抽選日時

---

## 7. UI/UX 要件

### 7.1 レスポンシブデザイン

- モバイルファースト
- LINE アプリ内での表示を最適化

### 7.2 アクセシビリティ

- ボタンのクリック領域を適切に確保
- テキストの視認性を確保

### 7.3 アニメーション

- 演出動画のスムーズな再生
- メニューの開閉アニメーション（必要に応じて）

---

## 8. 検討事項・未決定事項

### 8.1 データベース関連

- [ ] ユーザーテーブルは今すぐ必要か？（現在は userId のみ使用）
- [ ] 動画ファイルの保存方法（public フォルダ vs ストレージサービス）
- [ ] 抽選履歴の保持期間（データ削除ポリシー）
- [ ] ガチャアイテムの並び順（表示順序の管理）

### 8.2 機能拡張（Layer 3 以降）

- [ ] ふるさと納税連携
- [ ] ユーザーの獲得アイテム一覧表示機能
- [ ] コミュニティ機能（ポーカーアプリ内プラットフォーム）
- [ ] 商品バリエーション拡充（パラダイスシティ宿泊券、有名人と打てるなど）
- [ ] ガチャの期間限定イベント機能

### 8.3 セキュリティ・法的要件

- [ ] 管理画面の認証方法（現在はパスワードのみ）
- [ ] API のレート制限
- [ ] CORS 設定
- [ ] **賭博法への対応**（賭博法にふれないようにする）
- [ ] **景品表示法への対応**（景品法には気をつけながら進める）
  - 参考: https://corporate.vbest.jp/columns/9165/
- [ ] KYC（本人確認）身分証アップロードの必要性検討

---

## 9. 実装優先順位

### Layer 1: ガチャ基盤（MVP / 2 月 26 日必須）⭐

**目標**: ポーカーガチャの核となる"回せる仕組み"を実装

#### 必須機能（2/26 までに実装）

1. ⏳ **LINE ログインでユーザー識別**

   - LINE LIFF SDK による認証
   - ユーザー ID の取得と管理

2. ⏳ **商品ページ（カード UI）でガチャ選択**

   - カードタイプの UI 実装
   - ガチャタイプの選択機能

3. ⏳ **決済（Stripe/Chaty）**

   - Stripe または Chaty の統合
   - 決済フローの実装

4. ⏳ **ガチャ演出**

   - 全画面動画再生
   - スキップ機能
   - 期待値演出（ハンドレンジ強弱、好きなカード選択）

5. ⏳ **当選結果付与**

   - 当選商品の表示（1 等〜5 等、ハズレ）
   - バウチャー・クーポンの付与処理

6. ⏳ **敗者復活ガチャ（タグ制御）**

   - ハズレ時の敗者復活ガチャ
   - タグ制御による条件分岐

7. ⏳ **友達紹介システム（1 回ガチャ無料）** ⭐ 絶対必須
   - 紹介リンク生成
   - 紹介者・被紹介者への無料ガチャ付与
   - 紹介履歴管理

#### データベース連携（Layer 1 内）

1. ⏳ Prisma + PostgreSQL セットアップ
2. ⏳ データモデルの実装
3. ⏳ ガチャ抽選 API の DB 対応
4. ⏳ 抽選履歴の保存
5. ⏳ 友達紹介履歴の保存

---

### Layer 2: 管理画面（Layer 1 完了後）

1. ⏳ 管理画面の認証
2. ⏳ ガチャアイテム管理
3. ⏳ ガチャタイプ管理
4. ⏳ 抽選履歴管理
5. ⏳ 友達紹介統計

---

### Layer 3: 機能拡張（将来）

1. ⬜ **ふるさと納税連携**

   - ふるさと納税との連携機能
   - 収益構造の実装

2. ⬜ **ユーザー獲得アイテム一覧**

   - ユーザーが獲得したアイテムの一覧表示

3. ⬜ **コミュニティ機能**

   - ユーザー同士で繋がる仕組み
   - ポーカーがアプリ内で出来るプラットフォーム
   - タッグマッチペアを探せる機能
   - 仲間が募れるコミュニティ

4. ⬜ **商品バリエーション拡充**

   - パラダイスシティ宿泊券
   - 有名人と打てるなどの特別商品

5. ⬜ **統計機能の強化**
   - 詳細な統計表示
   - レポート機能

---

### 既存実装済み機能

1. ✅ ユーザー認証（LINE LIFF）
2. ✅ メインページ UI
3. ✅ ガチャ選択・抽選機能（基本）
4. ✅ 演出動画再生（基本）
5. ✅ 結果表示（基本）

---

## 10. 参考資料

- DB 設計: `DB_DESIGN.md`
- DB 物理設計: `DB物理設計_Layer1.md`
- プロジェクト構成: `README.md`
- 要件の AI との相談まとめ: `要件のAIとの相談まとめ.md`
- 友達紹介システム実装方法: `友達紹介システム実装方法.md`
- LINE メッセージ通知実装方法: `LINEメッセージ通知実装方法.md`
- Stripe 決済実装方法: `Stripe決済実装方法.md`
- L ガチャ参考資料: https://lp.l-funs.com/wp-content/uploads/2024/11/LFUNS_GACHA-1.pdf
- 景品表示法参考: https://corporate.vbest.jp/columns/9165/
- LINE Messaging API ドキュメント: https://developers.line.biz/ja/docs/messaging-api/
- Stripe ドキュメント: https://stripe.com/docs/jp

---

## 11. 開発体制

### チーム構成

- **要件定義・お客さん対応**: 野崎（L）、佐藤（S）
- **案件管理・全体進捗**: 野上（L）、野崎（S）
- **技術責任**: 佐藤（L）、野上（S）

### 開発方針

- 研究共同開発
- 報酬: チケットはピンキリ、10%は OK で前向きに検討
